---
title: Redis整数集合
date:  2021-04-12 22:17:43
toc: true
tags: 
- redis
- 2021
- redis 进阶
categories:
- 知识体系
---

原文：https://haicoder.net/note/redis-interview/redis-interview-redis-inset.html



**[Redis](https://haicoder.net/redis/redis-tutorial.html)** 中的整数集合(intset)并不是一个基础的数据结构，而是 Redis 自己设计的一种存储结构，是集合键的底层实现之一，当一个集合只包含整数值元素，并且这个集合的元素数量不多时, Redis 就会使用整数集合作为集合键的底层实现。
<!-- more -->

## 整数集合实现

整数集合(intset)是 Redis 用于保存整数值的集合抽象数据结构，它可以保存类型为 int16_t、int32_t 或者 int64_t 的整数值，并且保证集合中不会出现重复元素。结构定义如下：

```
//每个intset结构表示一个整数集合
typedef struct intset{
    //编码方式
    uint32_t encoding;
    //集合中包含的元素数量
    uint32_t length;
    //保存元素的数组
    int8_t contents[];
} intset;
```

contents 数组是整数集合的底层实现，整数集合的每个元素都是 contents 数组的个数组项(item)，各个项在数组中按值的大小从小到大有序地排列，并且数组中不包含任何重复项。

length 属性记录了数组的长度。

intset 结构将 contents 属性声明为 int8_t 类型的数组，但实际上 contents 数组并不保存任何 int8_t 类型的值, contents 数组的真正类型取决于 encoding 属性的值。encoding 属性的值为 INTSET_ENC_INT16 则数组就是 uint16_t 类型，数组中的每一个元素都是 int16_t 类型的整数值(-32768——32767)，encoding 属性的值为 INTSET_ENC_INT32 则数组就是 uint32_t 类型，数组中的每一个元素都是 int16_t 类型的整数值(-2147483648——2147483647)。

结构如下图所示：

![87_redis整数集合.png](https://wdj-1252419878.cos.ap-beijing.myqcloud.com/blog/2021-04-12-135438.png)

如上图，为一 int16_t 类型的整数集合，我们可以看到数组中存储了 5 个 int16_t 类型的整数，它们按照从小到大的顺序依次排列。这个时候我们思考一个问题。如果这个时候存入一个 int32_t 类型的整数会怎么样？内存溢出？这个时候就要提到整数集合的升级。

## 整数集合的升级

### 升级过程

正如上面所提到的问题，每当我们要将一个新元素添加到整数集合里面，并且新元素的类型比整数集合现有所有元素的类型都要长时，整数集合需要先进行升级，然后才能将新元素添加到整数集合里面。升级整数集合并添加新元素主要分三步来进行。

1. 根据新元素的类型，扩展整数集合底层数组的空间大小，并为新元素分配空间。
2. 将底层数组现有的所有元素都转换成与新元素相同的类型，并将类型转换后的元素放置到正确的位上，而且在放置元素的过程中，需要继续维持底层数组的有序性质不变。
3. 将新元素添加到底层数组里面。

![88_redis整数集合.png](https://wdj-1252419878.cos.ap-beijing.myqcloud.com/blog/2021-04-12-135442.png)

### 整数集合升级的优点

#### 提升灵活性

因为 **[C 语言](https://haicoder.net/c/c-tutorial.html)** 是静态类型语言，为了避免类型错误，我们通常不会将两种不同类型的值放在同一个数据结构里面。

例如，我们一般只使用 int16_t 类型的数组来保存 int16_t 类型的值，只使用 int32_t 类型的数组来保存 int32_t 类型的值，诸如此类。但是，因为整数集合可以通过自动升级底层数组来适应新元素，所以我们可以随意地将 int16_t、int32_t 或者 int64_t 类型的整数添加到集合中，而不必担心出现类型错误，这种做法非常灵活。

#### 节约内存

要让一个数组可以同时保存 int16_t、int32_t、int64_t 三种类型的值，最简单的做法就是直接使用 int64_t 类型的数组作为整数集合的底层实现。不过这样一来，即使添加到整数集合里面的都是 int16_t 类型或者 int32_t 类型的值，数组都需要使用 int64_t 类型的空间去保存它们，从而出现浪费内存的情况。

而整数集合现在的做法既可以让集合能同时保存三种不同类型的值，又可以确保升级操作只会在有需要的时候进行，这可以尽量节省内存。如果我们一直只向整数集合添加 int16_t 类型的值，那么整数集合的底层实现就会一直是 int16_t 类型的数组，只有在我们要将 int32_t 类型或者 int64_t 类型的值添加到集合时，程序才会对数组进行升级。

## 降级

整数集合不支持降级操作，一旦对数组进行了升级，编码就会一直保持升级后的状态。也就是说一旦我们向一个 int16_t 的整数集合内添加了一个 int32_t 的元素后，整数集合将升级到 int32_t 类型。即使后续的操作中我们删除了这个元素，整数集合还是会保持 int32_t 类型的状态。

## 整数集合常用操作时间复杂度

| 操作                     | 时间复杂度 |
| ------------------------ | ---------- |
| 创建一个新的整数集合     | O(1)       |
| 添加指定元素到集合       | O(N)       |
| 移除指定元素             | O(N)       |
| 判断指定元素是否在集合中 | O(logN)    |
| 随机返回一个元素         | O(1)       |
| 取出在指定索引上的元素   | O(1)       |
| 返回集合包含的元素个数   | O(1)       |
| 返回集合占用的内存字节数 | O(1)       |

## 总结

1. 整数集合是 Redis 自己设计的一种存储结构，集合键的底层实现之一。
2. 整数集合的底层实现为数组，这个数组以有序、无重复的方式保存集合元素，在有需要时，程序会根据新添加元素的类型，改变这个数组的类型。
3. 升级操作为整数集合带来了操作上的灵活性，并且尽可能地节约了内存。
4. 整数集合只支持升级操作，不支持降级操作。